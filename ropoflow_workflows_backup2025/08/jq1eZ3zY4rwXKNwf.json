{
  "active": false,
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Execution Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execution Data": {
      "main": [
        [
          {
            "node": "Está desde los origenes deseados?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "esta en tabla intermedia?": {
      "main": [
        [
          {
            "node": "Validar email y phone",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Está desde los origenes deseados?": {
      "main": [
        [
          {
            "node": "buscar lead en tabla intermedia",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "buscar lead en tabla intermedia": {
      "main": [
        [
          {
            "node": "esta en tabla intermedia?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar email y phone": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Select rows from a table",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select rows from a table": {
      "main": [
        [
          {
            "node": "Buscar contacto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-08-28T16:05:49.453Z",
  "id": "jq1eZ3zY4rwXKNwf",
  "isArchived": false,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "recibir leads impulsa",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/impulsa/oportunidad/:id_location",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        0,
        0
      ],
      "id": "df1854a3-94df-4298-af03-753483e4e3f7",
      "name": "Webhook",
      "webhookId": "56bafe2c-9754-4cd9-8f6e-dfce563b9878"
    },
    {
      "parameters": {
        "dataToSave": {
          "values": [
            {
              "key": "id_impulsa",
              "value": "={{ $json.body.ID }}"
            },
            {
              "key": "id_location",
              "value": "={{ $json.params.id_location }}"
            },
            {
              "key": "email",
              "value": "={{ $json.body.Email }}"
            },
            {
              "key": "phone",
              "value": "={{ $json.body.Telefono2 }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executionData",
      "typeVersion": 1.1,
      "position": [
        280,
        0
      ],
      "id": "2cfe4481-3a8c-49ef-9c2a-a2efa1dc03de",
      "name": "Execution Data"
    },
    {
      "parameters": {
        "jsCode": "return {\n  message: \"Origen no mapeado\"\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        160
      ],
      "id": "e6fed878-780c-43b7-a800-223ac9d35e33",
      "name": "Code"
    },
    {
      "parameters": {
        "jsCode": "return {\n  message: \"Ya el lead fue procesado (se encuentra en tabla intermedia)\"\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1240,
        -60
      ],
      "id": "e8222e53-09f1-4b82-9acf-ca316cee67f3",
      "name": "Code1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2e1f212b-14cc-4ee1-a210-043e33e3ea60",
              "leftValue": "={{ $json.id_impulsa }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1020,
        -160
      ],
      "id": "06eae1e0-80d3-4244-bacd-b73af88368c0",
      "name": "esta en tabla intermedia?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "a5d5388e-d9c6-435c-9253-821ad1f4514c",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "mobility lead",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "8f89c6d8-fe3d-4740-a7c4-0f3226a32a9c",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "auteco sas",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2834833a-14d4-42f5-ad86-36f54bcc2a9a",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "mobility test drive",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "c3da40a5-8267-4349-aecf-cbb18337ddff",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "hub-terminal",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2490a487-df3f-42fa-8555-0ab55085cace",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "origin_pilot_2",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "b099cd25-b88b-4d93-9aef-d49fed3067fc",
              "leftValue": "={{ $('Execution Data').item.json.body.Origen }}",
              "rightValue": "origin_pilot_3",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        560,
        0
      ],
      "id": "c248c7e0-fe5e-45e4-90e8-c798ae35a16f",
      "name": "Está desde los origenes deseados?"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "system_ropofy_opportunities_impulsa",
          "mode": "list",
          "cachedResultName": "system_ropofy_opportunities_impulsa"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "id_impulsa",
              "value": "={{ $json.body.ID + \"\" }}"
            },
            {
              "column": "id_location",
              "value": "={{ $json.params.id_location + \"\" }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        800,
        -140
      ],
      "id": "7ed7ccd4-882d-4d6b-8ad6-f582b2b49345",
      "name": "buscar lead en tabla intermedia",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "tfjc18K49daMASdp",
          "name": "Base de datos APIS"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Función para validar email usando regex y filter_var (equivalente en JS)\nfunction isValidEmail(email) {\n  if (!email || typeof email !== 'string') {\n    return false;\n  }\n  \n  // Expresión regular para validar el correo electrónico (misma que en PHP)\n  const regex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;\n  \n  // Verifica si el correo es válido y no contiene espacios\n  return regex.test(email) && !email.includes(' ');\n}\n\n// Obtener datos del request\nconst data = $('Webhook').first().json.body;\n\n// Variables para almacenar email y teléfono validados\nlet email = '';\nlet telefono = '';\n\n// Validar formato del email\n  if (data.Email && isValidEmail(data.Email)) {\n  console.log(\"ES VALIDO EL EMAIL\");\n  email = data.Email;\n} else {\n  console.log(\"ES INVALIDO EL EMAIL\");\n  data.Email = '';\n  email = \"\";\n}\n\n// Validar teléfono (verificar que existe)\nif (data.Telefono2 || data.Telefono2 || data.Telefono2) {\n  telefono = data.Telefono2 || data.Telefono2 || data.Telefono2;\n}\n\n// Verificar que al menos uno de los dos (email o teléfono) esté presente\nif (email === '' && telefono === '') {\n  return {\n    json: {\n      ...data,\n      email_validated: email,\n      phone_validated: telefono,\n      validation_passed: false\n    }\n  };\n}\n\n// Actualizar los datos con los valores validados\ndata.Email = email;\ndata.Telefono2 = telefono;\n\n// Retornar los datos validados\nreturn {\n  json: {\n    ...data,\n    email_validated: email,\n    phone_validated: telefono,\n    validation_passed: true\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1240,
        -260
      ],
      "id": "11b43055-10b8-4515-8408-bb0608d7d302",
      "name": "Validar email y phone"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e74b7067-9631-4524-82db-431aed6effd2",
              "leftValue": "={{ $json.validation_passed }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        1460,
        -260
      ],
      "id": "fbe1e418-a3d2-4732-96a1-9bbb9490ebd8",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "return {\n  message: \"Lead con los datos de email o phone malos\"\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1680,
        -160
      ],
      "id": "737493ce-5604-4fa3-ba7b-b5aca2ce61ac",
      "name": "Code2"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "public"
        },
        "table": {
          "__rl": true,
          "value": "system_ropofy_locations",
          "mode": "list",
          "cachedResultName": "system_ropofy_locations"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "location_id",
              "value": "={{ $('Webhook').item.json.params.id_location }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        1680,
        -360
      ],
      "id": "67244e27-2f40-4d2a-b1ad-1b6f4d2c4b8a",
      "name": "Select rows from a table",
      "credentials": {
        "postgres": {
          "id": "tfjc18K49daMASdp",
          "name": "Base de datos APIS"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://services.leadconnectorhq.com/contacts/search",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Accept",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "={{ $json.token }}"
            },
            {
              "name": "Version",
              "value": "2021-07-28"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"locationId\": \"{{ $json.location_id }}\",\n  \"page\": 1,\n  \"pageLimit\": 1,\n  \"filters\": [\n    {\n      \"group\": \"OR\",\n      \"filters\": [\n        {\n          \"field\": \"phone\",\n          \"operator\": \"eq\",\n          \"value\": \"{{ $('Validar email y phone').item.json.Telefono2 }}\"\n        },\n        {\n          \"field\": \"email\",\n          \"operator\": \"eq\",\n          \"value\": \"{{ $('Validar email y phone').item.json.Email }}\"\n        }\n      ]\n    }\n  ]\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1900,
        -360
      ],
      "id": "3ae81e1d-5ecb-4e8c-a8f5-291c682a37bb",
      "name": "Buscar contacto"
    }
  ],
  "pinData": {
    "Webhook": [
      {
        "json": {
          "headers": {
            "accept": "*/*",
            "host": "ropoflow-c4acfzgsbqa5bfad.canadacentral-01.azurewebsites.net",
            "user-agent": "PostmanRuntime/7.45.0",
            "accept-encoding": "gzip, deflate, br",
            "max-forwards": "10",
            "postman-token": "6f4776d5-0a4a-49e6-b405-b135bd5ccac0",
            "x-arr-log-id": "bca780d3-24c5-4878-a4fa-f39c71bf9b7f",
            "client-ip": "190.108.76.189:1808",
            "disguised-host": "ropoflow-c4acfzgsbqa5bfad.canadacentral-01.azurewebsites.net",
            "x-site-deployment-id": "ropoflow",
            "was-default-hostname": "ropoflow-c4acfzgsbqa5bfad.canadacentral-01.azurewebsites.net",
            "x-forwarded-proto": "https",
            "x-appservice-proto": "https",
            "x-arr-ssl": "2048|256|CN=Microsoft Azure RSA TLS Issuing CA 04, O=Microsoft Corporation, C=US|CN=*.azurewebsites.net, O=Microsoft Corporation, L=Redmond, S=WA, C=US",
            "x-forwarded-tlsversion": "1.3",
            "x-forwarded-for": "190.108.76.189:1808",
            "x-original-url": "/webhook-test/56bafe2c-9754-4cd9-8f6e-dfce563b9878/impulsa/oportunidad/gwxnQP0jeV98khFZDNSk",
            "x-waws-unencoded-url": "/webhook-test/56bafe2c-9754-4cd9-8f6e-dfce563b9878/impulsa/oportunidad/gwxnQP0jeV98khFZDNSk",
            "x-client-ip": "190.108.76.189",
            "x-client-port": "1808",
            "content-type": "application/json",
            "content-length": "694"
          },
          "params": {
            "id_location": "gwxnQP0jeV98khFZDNSk"
          },
          "query": {},
          "body": {
            "ID": 455667,
            "IDOportunidadAuteco": "Nbvd0bdvuh1h0oZ4bPdw",
            "Origen": "mobility lead",
            "Campanna": "Whatsapp",
            "Establecimiento": "551056518",
            "Productos": [
              {
                "Producto": "PRODUCTO",
                "Marca": "MARCA"
              }
            ],
            "Observaciones": "prueba 1 tecnologia",
            "TipoDocumento": "CC",
            "Documento": "12324345",
            "NombreContacto": "tecnologia ropofy",
            "Email": "juanperez@example.com",
            "Telefono2": "3127263465",
            "CodigoDANE": "76001",
            "Direccion": null,
            "HabeasData": true,
            "Sistema": "auteco",
            "NivelInteres": "CC",
            "Usuario": "ColprodexSAS",
            "Estado": "PE",
            "NitCompania": "900892851"
          },
          "webhookUrl": "https://ropoflow-c4acfzgsbqa5bfad.canadacentral-01.azurewebsites.net/webhook-test/56bafe2c-9754-4cd9-8f6e-dfce563b9878/impulsa/oportunidad/:id_location",
          "executionMode": "test"
        }
      }
    ]
  },
  "repo_name": "ropoflow_workflows_backup",
  "repo_owner": "sebastianOrtizRopofy",
  "repo_path": "ropoflow_workflows_backup",
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 0,
  "updatedAt": "2025-08-29T17:04:04.506Z",
  "versionId": "1aefb9f2-1baa-4755-b29d-863898d160de"
}